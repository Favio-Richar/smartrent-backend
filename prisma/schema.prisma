// =============================================================
// SMARTRENT+ - Prisma Schema (PostgreSQL)
// =============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- Estado de Propiedad ----------
enum PropertyState {
  draft
  published
  paused
  archived
}

// ========================= USERS =============================
model User {
  id               Int       @id @default(autoincrement())
  nombre           String
  correo           String    @unique
  email            String?   @unique
  contrasena       String
  telefono         String?
  ciudad           String?
  imagen           String?
  bio              String?   @db.Text
  facebook         String?
  instagram        String?
  linkedin         String?
  web              String?
  tipoCuenta       String    @default("Usuario")
  fechaRegistro    DateTime  @default(now())
  isActive         Boolean   @default(true)
  lastLogin        DateTime?
  resetCode        String?
  resetCodeExpires DateTime?

  publicaciones Property[]
  empleos       Job[]           @relation("UserJobs")
  favoritos     Favorite[]
  comentarios   Comment[]
  postulaciones Application[]
  tickets       SupportTicket[]
  reservations  Reservation[] // reservas hechas por este usuario

  @@index([tipoCuenta])
  @@index([fechaRegistro])
  @@index([resetCode])
}

// ======================== COMPANIES ==========================
model Company {
  id            Int      @id @default(autoincrement())
  nombreEmpresa String
  correo        String   @unique
  contrasena    String
  telefono      String?
  direccion     String?
  descripcion   String?
  logo          String?
  fechaRegistro DateTime @default(now())

  empleos     Job[]
  propiedades Property[]

  @@index([fechaRegistro])
}

// ======================== PROPERTIES =========================
model Property {
  id               Int      @id @default(autoincrement())
  titulo           String
  descripcion      String
  precio           Float
  categoria        String
  ubicacion        String
  comuna           String?
  tipo             String?
  imagen           String?
  videoUrl         String?
  latitude         Float?
  longitude        Float?
  destacado        Boolean  @default(false)
  area             Int?
  dormitorios      Int?
  banos            Int?
  anio             Int?
  fechaPublicacion DateTime @default(now())
  metadata         Json?
  companyName      String?
  contactName      String?
  contactPhone     String?
  contactEmail     String?
  whatsapp         String?
  website          String?

  // MÃ©tricas/estado
  visitas  Int           @default(0)
  reservas Int           @default(0)
  state    PropertyState @default(draft)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())  // ðŸ‘ˆ agrega @default(now())

  userId    Int?
  companyId Int?

  user         User?         @relation(fields: [userId], references: [id])
  company      Company?      @relation(fields: [companyId], references: [id])
  comentarios  Comment[]
  favoritos    Favorite[]
  reservations Reservation[] // reservas sobre esta propiedad

  @@index([categoria])
  @@index([comuna])
  @@index([tipo])
  @@index([precio])
  @@index([fechaPublicacion])
  @@index([state])
}

// =========================== JOBS ============================
model Job {
  id               Int      @id @default(autoincrement())
  titulo           String
  descripcion      String
  categoria        String
  tipoContrato     String
  ubicacion        String
  salario          Float?
  fechaPublicacion DateTime @default(now())

  companyId Int?
  userId    Int?

  company       Company?      @relation(fields: [companyId], references: [id])
  user          User?         @relation("UserJobs", fields: [userId], references: [id])
  postulaciones Application[]
  favoritos     Favorite[]

  @@index([categoria])
  @@index([tipoContrato])
  @@index([fechaPublicacion])
}

// ======================== APPLICATIONS =======================
model Application {
  id               Int      @id @default(autoincrement())
  userId           Int
  jobId            Int
  fechaPostulacion DateTime @default(now())
  estado           String   @default("En revisiÃ³n")

  user User @relation(fields: [userId], references: [id])
  job  Job  @relation(fields: [jobId], references: [id])

  @@index([userId])
  @@index([jobId])
  @@index([estado])
  @@index([fechaPostulacion])
}

// ======================= SUBSCRIPTIONS =======================
model Subscription {
  id           Int     @id @default(autoincrement())
  nombrePlan   String
  precio       Float
  descripcion  String?
  duracionDias Int
  nivel        String

  @@index([nivel])
}

// ========================= FAVORITES =========================
model Favorite {
  id         Int  @id @default(autoincrement())
  userId     Int
  propertyId Int?
  jobId      Int?

  user     User      @relation(fields: [userId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])
  job      Job?      @relation(fields: [jobId], references: [id])

  @@index([userId])
  @@index([propertyId])
  @@index([jobId])
}

// ========================== COMMENTS =========================
model Comment {
  id         Int      @id @default(autoincrement())
  contenido  String
  fecha      DateTime @default(now())
  userId     Int
  propertyId Int?

  user     User      @relation(fields: [userId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])

  @@index([userId])
  @@index([propertyId])
  @@index([fecha])
}

// ====================== SUPPORT TICKETS ======================
model SupportTicket {
  id            Int      @id @default(autoincrement())
  asunto        String
  descripcion   String
  estado        String   @default("Pendiente")
  fechaCreacion DateTime @default(now())

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([estado])
  @@index([fechaCreacion])
}

// ========================= RESERVATIONS ======================
model Reservation {
  id         Int      @id @default(autoincrement())
  propertyId Int
  userId     Int
  startDate  DateTime
  endDate    DateTime
  message    String?  @db.Text
  people     Int      @default(1)
  status     String   @default("Pendiente") // Pendiente | Aprobada | Cancelada
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@index([propertyId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
