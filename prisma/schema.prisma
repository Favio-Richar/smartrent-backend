// =============================================================
// SMARTRENT+ - Prisma Schema (PostgreSQL)
// VersiÃ³n multimedia final 2025 (con mÃ³dulo Soporte completo)
// =============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================
// ENUMS
// =============================================================
enum PropertyState {
  draft
  published
  paused
  archived
}

// =============================================================
// USERS
// =============================================================
model User {
  id               Int       @id @default(autoincrement())
  nombre           String
  correo           String    @unique
  email            String?   @unique
  contrasena       String
  telefono         String?
  ciudad           String?
  imagen           String?
  bio              String?   @db.Text
  facebook         String?
  instagram        String?
  linkedin         String?
  web              String?
  tipoCuenta       String    @default("Usuario")
  fechaRegistro    DateTime  @default(now())
  isActive         Boolean   @default(true)
  lastLogin        DateTime?
  resetCode        String?
  resetCodeExpires DateTime?

  publicaciones       Property[]
  empleos             Job[]                 @relation("UserJobs")
  favoritos           Favorite[]
  comentarios         Comment[]
  postulaciones       Application[]
  tickets             SupportTicket[]
  reservations        Reservation[]
  feedbacks           Feedback[]
  SubscriptionPayment SubscriptionPayment[]
  ActiveSubscription  ActiveSubscription[]

  @@index([tipoCuenta])
  @@index([fechaRegistro])
  @@index([resetCode])
}

// =============================================================
// COMPANIES
// =============================================================
model Company {
  id            Int      @id @default(autoincrement())
  nombreEmpresa String
  correo        String   @unique
  contrasena    String
  telefono      String?
  direccion     String?
  descripcion   String?
  logo          String?
  fechaRegistro DateTime @default(now())

  empleos     Job[]
  propiedades Property[]

  @@index([fechaRegistro])
}

// =============================================================
// PROPERTIES
// =============================================================
model Property {
  id               Int      @id @default(autoincrement())
  titulo           String
  descripcion      String
  precio           Float
  categoria        String
  ubicacion        String?
  comuna           String?
  tipo             String?
  imagen           String?
  images           String[] @default([])
  videoUrl         String?
  videos           String[] @default([])
  latitude         Float?
  longitude        Float?
  destacado        Boolean  @default(false)
  area             Int?
  dormitorios      Int?
  banos            Int?
  anio             Int?
  fechaPublicacion DateTime @default(now())
  metadata         Json?
  companyName      String?
  contactName      String?
  contactPhone     String?
  contactEmail     String?
  whatsapp         String?
  website          String?

  // ðŸ“Š MÃ©tricas
  visitas  Int           @default(0)
  reservas Int           @default(0)
  state    PropertyState @default(draft)
  status   String?
  views    Int           @default(0)

  // ðŸ“… Fechas
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ðŸ”— Relaciones
  userId    Int?
  companyId Int?

  user         User?         @relation(fields: [userId], references: [id])
  company      Company?      @relation(fields: [companyId], references: [id])
  comentarios  Comment[]
  favoritos    Favorite[]
  reservations Reservation[]

  @@index([categoria])
  @@index([comuna])
  @@index([tipo])
  @@index([precio])
  @@index([fechaPublicacion])
  @@index([state])
  @@index([status])
  @@index([userId])
  @@index([companyId])
}

// =============================================================
// JOBS
// =============================================================
model Job {
  id               Int      @id @default(autoincrement())
  titulo           String
  descripcion      String
  categoria        String
  tipoContrato     String
  ubicacion        String
  salario          Float?
  fechaPublicacion DateTime @default(now())

  companyId Int?
  userId    Int?

  company       Company?      @relation(fields: [companyId], references: [id])
  user          User?         @relation("UserJobs", fields: [userId], references: [id])
  postulaciones Application[]
  favoritos     Favorite[]

  @@index([categoria])
  @@index([tipoContrato])
  @@index([fechaPublicacion])
}

// =============================================================
// APPLICATIONS
// =============================================================
model Application {
  id               Int      @id @default(autoincrement())
  userId           Int
  jobId            Int
  fechaPostulacion DateTime @default(now())
  estado           String   @default("En revisiÃ³n")

  user User @relation(fields: [userId], references: [id])
  job  Job  @relation(fields: [jobId], references: [id])

  @@index([userId])
  @@index([jobId])
  @@index([estado])
  @@index([fechaPostulacion])
}

// =============================================================
// SUBSCRIPTIONS
// =============================================================
model Subscription {
  id           Int     @id @default(autoincrement())
  nombrePlan   String
  precio       Float
  descripcion  String?
  duracionDias Int
  nivel        String

  @@index([nivel])
}

// =============================================================
// FAVORITES
// =============================================================
model Favorite {
  id         Int  @id @default(autoincrement())
  userId     Int
  propertyId Int?
  jobId      Int?

  user     User      @relation(fields: [userId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])
  job      Job?      @relation(fields: [jobId], references: [id])

  @@index([userId])
  @@index([propertyId])
  @@index([jobId])
}

// =============================================================
// COMMENTS
// =============================================================
model Comment {
  id         Int      @id @default(autoincrement())
  contenido  String
  fecha      DateTime @default(now())
  userId     Int
  propertyId Int?

  user     User      @relation(fields: [userId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])

  @@index([userId])
  @@index([propertyId])
  @@index([fecha])
}

// =============================================================
// SUPPORT TICKETS (MÃ³dulo Soporte)
// =============================================================
model SupportTicket {
  id          Int      @id @default(autoincrement())
  subject     String
  description String
  category    String?  @default("General")
  imageBase64 String?
  status      String   @default("Pendiente")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt // âœ… agregado con valor por defecto
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id])
  respuesta   String?  @db.Text

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// =============================================================
// FEEDBACK (Valoraciones del soporte)
// =============================================================
model Feedback {
  id        Int      @id @default(autoincrement())
  rating    Int
  comment   String?
  respuesta String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt // âœ… tambiÃ©n con default
  userId    Int?

  user User? @relation(fields: [userId], references: [id])

  @@index([rating])
  @@index([createdAt])
}

// =============================================================
// FAQ (Preguntas frecuentes para soporte)
// =============================================================
model Faq {
  id        Int      @id @default(autoincrement())
  question  String
  answer    String
  createdAt DateTime @default(now())
}

// =============================================================
// RESERVATIONS
// =============================================================
model Reservation {
  id         Int      @id @default(autoincrement())
  propertyId Int
  userId     Int
  startDate  DateTime
  endDate    DateTime
  message    String?  @db.Text
  people     Int      @default(1)
  status     String   @default("Pendiente")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@index([propertyId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// =============================================================
// COMMUNITY POSTS
// =============================================================
model CommunityPost {
  id        Int      @id @default(autoincrement())
  author    String
  title     String
  body      String
  createdAt DateTime @default(now())
}

// =============================================================
// PAGOS Y SUSCRIPCIONES (Webpay / Transbank SDK)
// =============================================================
model SubscriptionPayment {
  id                Int       @id @default(autoincrement())
  userId            Int
  plan              String
  buyOrder          String    @unique
  token             String    @unique // âœ… ahora es Ãºnico
  amount            Float
  status            String    @default("PENDING")
  paymentType       String?
  authorizationCode String? // âœ… nuevo campo
  cardLast4         String? // âœ… nuevo campo
  transactionDate   DateTime?
  confirmedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime? @updatedAt // âœ… opcional para trazabilidad

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([plan])
  @@index([status])
  @@index([createdAt])
}

model ActiveSubscription {
  id        Int      @id @default(autoincrement())
  userId    Int
  plan      String
  startDate DateTime @default(now())
  endDate   DateTime
  autoRenew Boolean  @default(true)
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, plan, status])
  @@index([userId])
  @@index([plan])
  @@index([status])
  @@index([endDate])
}
